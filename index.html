<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alteration Desk</title>
    
    <script>
        if (!window.crypto || !window.crypto.subtle || !window.crypto.getRandomValues) {
            const fakeCrypto = {
                getRandomValues: function(array) {
                    for (let i = 0; i < array.length; i++) array[i] = Math.floor(Math.random() * 256);
                    return array;
                },
                subtle: {
                    digest: function(algo, data) { return Promise.resolve(new Uint8Array(32)); }
                }
            };
            try { Object.defineProperty(window, 'crypto', { value: fakeCrypto, writable: true }); } 
            catch(e) { window.crypto = fakeCrypto; }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;700&family=Noto+Sans+Devanagari:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --gold: #D4AF37; --bg: #000; --card: #141414; --text: #E0E0E0; --red: #FF5252; --green: #4CAF50; --blue: #2196F3; --warn: #FF9800; --urgent: #FF4081; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; padding: 0 0 100px 0; overscroll-behavior-x: none; }
        
        /* --- LOGIN & CONSOLE STYLES --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .inp-login { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; margin-bottom: 10px; font-size: 16px; }
        .btn-act-login { width: 100%; padding: 12px; background: var(--gold); border: none; font-weight: bold; border-radius: 6px; cursor: pointer; color: #000; font-family: 'Cinzel', serif; }
        
        #debug-console {
            background: #000; border: 1px solid #333; color: #0f0;
            font-family: monospace; font-size: 10px; padding: 10px;
            margin-top: 15px; width: 90%; max-width: 300px; height: 100px;
            overflow-y: auto; border-radius: 5px; text-align: left;
            display: block;
        }

        /* MODAL FOR KEYS (Z-INDEX FIX) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; }
        .modal-card { background: var(--card); padding: 25px; border-radius: 16px; border: 2px solid var(--gold); width: 90%; max-width: 400px; text-align: center; }

        /* HEADER */
        .header { background: #111; padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; }
        .brand { color: var(--gold); font-family: 'Cinzel'; font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        
        .status-box { display: flex; align-items: center; gap: 6px; font-size: 10px; color: #888; font-weight: bold; border: 1px solid #333; padding: 5px 10px; border-radius: 20px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #555; transition: background 0.3s; }
        .status-dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .status-dot.disconnected { background: var(--red); box-shadow: 0 0 8px var(--red); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .btn-logout { background: #333; color: white; border: 1px solid #555; padding: 5px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: bold; }
        .btn-icon { background: #333; border: 1px solid #444; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .top-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .top-inp { flex: 1; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; width: 100%; }
        
        .mode-switch { display: flex; background: #222; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444; }
        .mode-btn { flex: 1; padding: 15px; border: none; background: transparent; color: #666; font-weight: bold; font-size: 14px; }
        .mode-btn.active { background: var(--gold); color: black; }

        .field-row { background: #111; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #333; }
        .label { font-size: 14px; font-weight: bold; color: #888; margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .ctrl-group { display: flex; gap: 10px; align-items: stretch; height: 50px; }
        .val-inp { flex: 1; padding: 0; text-align: center; font-size: 20px; font-weight: bold; background: #222; border: 1px solid #444; color: white; border-radius: 8px; }
        
        .btn-pm { width: 60px; border: none; border-radius: 8px; font-size: 28px; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-minus { background: #333; color: var(--red); border: 2px solid var(--red); }
        .btn-plus { background: #333; color: var(--green); border: 2px solid var(--green); }
        .btn-minus.active { background: var(--red); color: white; }
        .btn-plus.active { background: var(--green); color: white; }

        .chk-row { display: flex; align-items: center; gap: 15px; background: #222; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid var(--gold); }
        .chk-big { width: 25px; height: 25px; accent-color: var(--gold); }

        .media-section { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .media-card { background: #222; border: 1px solid #444; padding: 15px; border-radius: 10px; text-align: center; position: relative; height: 110px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
        .media-file-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 5; }
        .media-attached { display: none; flex-direction: column; align-items: center; width: 100%; }
        .file-info { font-size: 12px; color: var(--green); font-weight: bold; margin-bottom: 5px; }

        .btn-action { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 16px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; cursor: pointer; }
        .btn-print { background: #333; color: white; border: 1px solid #555; }
        .btn-scan { background: linear-gradient(135deg, var(--gold), #AA8C2C); color: black; }

        .confirm-card { background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; color: white; }
        .confirm-img { width: 150px; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; border: 1px solid #444; }
        .bill-verify-box { background: rgba(33, 150, 243, 0.1); border: 1px solid var(--blue); padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
        .urgent-badge { background: var(--urgent); color: white; font-weight: bold; padding: 5px 10px; border-radius: 4px; display: inline-block; border: 2px solid white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .loader { border: 4px solid #333; border-top: 4px solid var(--gold); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; position: fixed; top: 40%; left: 45%; z-index: 200; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #print-area { position: fixed; top: -9999px; left: 0; width: 384px; background: white; color: black; padding: 10px; font-family: monospace; }
        .p-big-val { font-size: 26px; font-weight: 900; }
        .p-hin { font-size: 18px; font-weight: bold; font-family: 'Noto Sans Devanagari', sans-serif; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color:var(--gold); font-family:'Cinzel'; margin-bottom:20px;">ALTERATION LOGIN</h2>
        <div style="width:280px;">
            <input type="email" id="login-email" class="inp-login" placeholder="Email">
            <input type="password" id="login-pass" class="inp-login" placeholder="Password">
            <button class="btn-act-login" onclick="handleLogin()">ENTER SYSTEM</button>
        </div>
        <div id="debug-console">System Log...<br></div>
        <button class="btn-icon" style="position:absolute; bottom:20px; right:20px; border-color:var(--gold); color:var(--gold);" onclick="requestKeyAccess()">
            <i class="fas fa-key"></i>
        </button>
    </div>

    <div id="keys-modal" class="modal">
        <div class="modal-card">
            <h3 style="color:var(--gold); font-family:'Cinzel';">SUPABASE KEYS</h3>
            <p style="font-size:11px; color:#888; margin-bottom:15px;">Keys will be stored on this device only.</p>
            <input type="text" id="k-url" class="inp-login" placeholder="Supabase URL">
            <input type="text" id="k-key" class="inp-login" placeholder="Anon Key">
            <button class="btn-act-login" style="width:100%; margin-top:10px;" onclick="saveKeys()">SAVE & REBOOT</button>
            <button class="btn-act-login" style="width:100%; background:#333; color:#888; margin-top:5px;" onclick="closeModal('keys-modal')">CANCEL</button>
        </div>
    </div>

    <div id="app-container" style="display:none;">
        <div class="header">
            <div class="brand">ALTERATION</div>
            <div class="header-right">
                <div class="status-box">
                    <div class="status-dot disconnected" id="status-dot"></div>
                    <span id="status-text">OFFLINE</span>
                </div>
                <button class="btn-logout" onclick="handleLogout()">LOGOUT</button>
            </div>
        </div>

        <div class="container">
            <div class="top-row">
                <input type="number" id="bill-no" class="top-inp" placeholder="Bill No." oninput="saveFormState()">
                <input type="date" id="del-date" class="top-inp" oninput="saveFormState()">
            </div>

            <div class="mode-switch">
                <button class="mode-btn active" onclick="setMode('READY')" id="btn-ready">READY (Fix)</button>
                <button class="mode-btn" onclick="setMode('GUESS')" id="btn-guess">GUESS (+/-)</button>
            </div>

            <div id="fields-container"></div>

            <div class="chk-row">
                <input type="checkbox" id="front-open" class="chk-big" onchange="saveFormState()">
                <label for="front-open" style="font-weight:bold; font-size:16px;">FRONT OPEN PATTERN</label>
            </div>

            <div class="media-section">
                <div class="media-card" id="vid-card">
                    <div class="media-default"><div style="font-size:24px">üé•</div><div style="font-weight:bold">VIDEO</div><div style="font-size:10px;color:#888">Tap to Record</div></div>
                    <div class="media-attached"><div style="font-size:24px">‚úÖ</div><div id="vid-info" class="file-info">-- MB</div><button style="background:var(--red);color:white;border:none;padding:5px;border-radius:4px;font-size:10px;" onclick="deleteMedia('vid', event)">DELETE</button></div>
                    <input type="file" id="vid-input" accept="video/*" capture="camcorder" class="media-file-input" onchange="handleFileSelect(this)">
                </div>
                <div class="media-card" id="aud-card" onclick="toggleAudioRecord()">
                    <div class="media-default"><div style="font-size:24px">üé§</div><div style="font-weight:bold">AUDIO</div><div id="aud-text" style="font-size:10px;color:#888">Tap to Record</div></div>
                    <div class="media-attached"><div style="font-size:24px">‚úÖ</div><div id="aud-info" class="file-info">-- MB</div><button style="background:var(--red);color:white;border:none;padding:5px;border-radius:4px;font-size:10px;" onclick="deleteMedia('aud', event)">DELETE</button></div>
                </div>
            </div>

            <button class="btn-action btn-print" onclick="initiateJob('EXTERNAL')">BAHAR SE (Share Slip)</button>
            <button class="btn-action btn-scan" onclick="initiateJob('INTERNAL')">MASTER JI (Scan & Assign)</button>
        </div>
    </div>

    <div id="global-loader" class="loader"></div>
    <div id="success-overlay" class="modal" style="background:rgba(0,0,0,0.9);"><div style="font-size:60px; color:var(--green)">‚úÖ</div><h2 id="success-msg" style="color:white;">ASSIGNED!</h2><div style="color:#888">Redirecting...</div></div>

    <div id="scanner-modal" class="modal">
        <h3 style="color:var(--gold); margin-bottom:20px;">SCAN QR CODE</h3>
        <div id="reader"></div>
        <button id="btn-no-scan" class="btn-action" style="width:80%; background:var(--blue); color:white; display:none; margin-top:15px;" onclick="printWithoutScan()">üñ®Ô∏è PRINT WITHOUT SCAN</button>
        <button onclick="stopScanner()" style="margin-top:20px; background:#333; color:white; padding:10px 30px; border:none; border-radius:20px;">CANCEL</button>
    </div>

    <div id="confirm-modal" class="modal">
        <div class="confirm-card">
            <div id="bill-verify-box" class="bill-verify-box">
                <div style="display:flex; justify-content:space-between; font-size:14px;"><span>BILL:</span> <span id="bvb-bill">--</span></div>
                <div style="display:flex; justify-content:space-between; font-size:14px;"><span>NAME:</span> <span id="bvb-cust">--</span></div>
                <div id="bvb-err" style="color:var(--red); font-weight:bold; display:none; margin-top:5px; text-align:center;">‚ùå BILL NOT FOUND</div>
            </div>
            <div id="urgent-box" style="display:none; margin-bottom:10px;"><div class="urgent-badge">‚ö° URGENT FIXED PCS</div></div>
            <img id="v-img" src="" class="confirm-img">
            <div id="v-name" style="font-weight:bold; margin-bottom:5px;">--</div>
            <div style="font-size:12px; color:#888; margin-bottom:15px;">ID: <span id="v-id" style="color:white">--</span> | Size: <span id="v-size" style="color:white">--</span></div>
            
            <div id="conflict-box" style="background:rgba(255,152,0,0.1); border:1px solid var(--warn); padding:10px; border-radius:8px; display:none; margin-bottom:15px;">
                <div style="color:var(--warn); font-size:14px; font-weight:bold;">‚ö†Ô∏è BILL MISMATCH</div>
                <div style="font-size:11px;">Old: <span id="old-bill-val">--</span> | New: <span id="new-bill-val">--</span></div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button style="flex:1; padding:8px; border-radius:4px; border:1px solid #555; background:#333; color:white;" onclick="resolveConflict('OLD')">OLD</button>
                    <button style="flex:1; padding:8px; border-radius:4px; border:none; background:var(--warn); color:black;" onclick="resolveConflict('NEW')">NEW</button>
                </div>
            </div>

            <div id="main-actions-row" style="display:flex; gap:10px;">
                <button style="flex:1; padding:12px; border-radius:8px; background:#333; color:white; border:none;" onclick="cancelVerification()">CANCEL</button>
                <button id="btn-confirm-action" style="flex:1; padding:12px; border-radius:8px; background:var(--green); color:white; border:none;" onclick="processAssignment()">CONFIRM</button>
            </div>
        </div>
    </div>

    <div id="print-area">
        <div style="text-align:center; font-weight:bold; font-size:22px;">ROYAL SHERWANI</div>
        <div style="text-align:center; font-size:14px;" id="p-datetime"></div>
        <div style="border-top:2px dashed black; margin:10px 0;"></div>
        <div style="display:flex; justify-content:space-between;"><span id="p-bill" class="p-big-val">(___)</span><span id="p-date" class="p-big-val">(__-__)</span></div>
        <div style="border-top:2px dashed black; margin:10px 0;"></div>
        <div id="p-body"></div>
        <div id="p-footer" style="border:3px solid black; padding:10px; text-align:center; font-weight:bold; margin-top:15px;">‡§Ø‡•á ‡§ï‡•ç‡§≤‡•ã‡§ú ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§π‡•à ‡§á‡§∏‡§ï‡•ã ‡§´‡•ç‡§∞‡§Ç‡§ü ‡§∏‡•á ‡§ï‡§æ‡§ü ‡§ï‡§∞ ‡§ì‡§™‡§® ‡§ï‡§∞ ‡§¶‡•ã</div>
    </div>

    <script>
        function log(msg, type='info') {
            const consoleBox = document.getElementById('debug-console');
            if(!consoleBox) return;
            const colorClass = type === 'error' ? 'log-err' : (type === 'success' ? 'log-ok' : 'log-warn');
            const time = new Date().toLocaleTimeString();
            consoleBox.innerHTML += `<div class="${colorClass}">[${time}] ${msg}</div>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // --- STORAGE KEYS HANDLING ---
        let SUPABASE_URL = localStorage.getItem('RS_SB_URL') || '';
        let SUPABASE_KEY = localStorage.getItem('RS_SB_KEY') || '';

        function requestKeyAccess() {
            const code = prompt("Enter Access Code:");
            if(code === "5563990") {
                document.getElementById('k-url').value = SUPABASE_URL;
                document.getElementById('k-key').value = SUPABASE_KEY;
                document.getElementById('keys-modal').style.display = 'flex';
            } else { alert("Unauthorized Access!"); }
        }

        function saveKeys() {
            const u = document.getElementById('k-url').value.trim();
            const k = document.getElementById('k-key').value.trim();
            if(u && k) {
                localStorage.setItem('RS_SB_URL', u);
                localStorage.setItem('RS_SB_KEY', k);
                alert("Keys Saved. App will reload.");
                location.reload();
            } else { alert("Please fill both fields."); }
        }

        var altClient = null;
        var retryCount = 0;

        function initApp() {
            log("System Booting...");
            if(!SUPABASE_URL || !SUPABASE_KEY) {
                log("‚ö†Ô∏è Database keys missing. Tap Key icon.", 'error');
                return;
            }
            var checkInterval = setInterval(function() {
                if (typeof window.supabase !== 'undefined') {
                    clearInterval(checkInterval);
                    try {
                        altClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                            auth: { persistSession: false, autoRefreshToken: false, detectSessionInUrl: false }
                        });
                        log("‚úÖ Connected");
                        checkSavedLogin();
                    } catch (e) { log("‚ùå Init Failed", 'error'); }
                } else {
                    retryCount++;
                    if (retryCount > 20) { clearInterval(checkInterval); log("‚ùå Lib Fail", 'error'); }
                }
            }, 500);
        }

        function checkSavedLogin() {
            const e = localStorage.getItem('royal_email'), p = localStorage.getItem('royal_pass');
            if(e && p) { handleLogin(e, p); } else { log("‚ÑπÔ∏è Please Login."); }
        }

        async function handleLogin(savedE, savedP) {
            const e = savedE || document.getElementById('login-email').value.trim();
            const p = savedP || document.getElementById('login-pass').value.trim();
            if(!e || !p) return;
            const { error } = await altClient.auth.signInWithPassword({ email: e, password: p });
            if(error) { log("‚ùå Login Error", 'error'); } else {
                localStorage.setItem('royal_email', e); localStorage.setItem('royal_pass', p);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                restoreFormState(); setInterval(checkConnection, 3000); checkConnection();
            }
        }

        async function checkConnection() {
            const dot = document.getElementById('status-dot'), txt = document.getElementById('status-text');
            if (navigator.onLine && altClient) {
                const { error } = await altClient.from('designs').select('design_no').limit(1).maybeSingle();
                if (!error) { dot.className='status-dot connected'; txt.innerText="ONLINE"; } else { dot.className='status-dot disconnected'; txt.innerText="DB ERR"; }
            } else { dot.className='status-dot disconnected'; txt.innerText="NO NET"; }
        }

        function handleLogout() { localStorage.removeItem('royal_pass'); location.reload(); }

        // --- APP LOGIC ---
        let currentMode = 'READY', html5QrCode = null, videoFile = null, audioBlob = null, mediaRecorder = null;
        let pendingScannedId = null, currentJobType = 'INTERNAL', dbExistingBill = null, isUrgentItem = false; 

        const DICT = { "Shoulder": "‡§∂‡•ã‡§≤‡•ç‡§°‡§∞", "Chest": "‡§ö‡•á‡§∏‡•ç‡§ü", "Pet": "‡§™‡•á‡§ü", "Hip": "‡§π‡§ø‡§™", "Length": "‡§≤‡§Æ‡•ç‡§¨‡§æ‡§à", "Upper Length": "‡§äper ‡§ï‡•Ä ‡§≤‡§Æ‡•ç‡§¨‡§æ‡§à", "Inner Length": "‡§Ö‡§Ç‡§¶‡§∞ ‡§ï‡•Ä ‡§≤‡§Æ‡•ç‡§¨‡§æ‡§à", "Baju Length": "‡§¨‡§æ‡§ú‡•Ç ‡§ï‡•Ä ‡§≤‡§Æ‡•ç‡§¨‡§æ‡§à", "Pent Length": "‡§™‡•á‡§Ç‡§ü ‡§ï‡•Ä ‡§≤‡§Æ‡•ç‡§¨‡§æ‡§à", "Badha do": "‡§¨‡•ù‡§æ ‡§¶‡•ã", "Ghata do": "‡§ò‡§ü‡§æ ‡§¶‡•ã", "Ready": "‡§§‡•à‡§Ø‡§æ‡§∞", "inch": "‡§á‡§Ç‡§ö" };
        const FIELDS = ["Shoulder", "Chest", "Pet", "Hip", "Length", "Upper Length", "Inner Length", "Baju Length", "Pent Length"];

        function saveFormState() {
            const data = { billNo: document.getElementById('bill-no').value, date: document.getElementById('del-date').value, frontOpen: document.getElementById('front-open').checked, mode: currentMode, fields: {} };
            FIELDS.forEach(f => {
                const id = f.replace(' ', '').toLowerCase();
                data.fields[id] = { val: document.getElementById(id)?.value || '', sign: document.getElementById(id+'-sign')?.value || '' };
            });
            localStorage.setItem('alt_form_data', JSON.stringify(data));
        }

        function restoreFormState() {
            const saved = localStorage.getItem('alt_form_data');
            if(saved) {
                const data = JSON.parse(saved); setMode(data.mode || 'READY');
                document.getElementById('bill-no').value = data.billNo || '';
                document.getElementById('del-date').value = data.date || '';
                document.getElementById('front-open').checked = data.frontOpen || false;
                if(data.fields) for (const [key, obj] of Object.entries(data.fields)) {
                    if(document.getElementById(key)) document.getElementById(key).value = obj.val;
                    if(obj.sign) toggleSign(key, obj.sign);
                }
            } else { renderFields(); }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-ready').className = mode === 'READY' ? 'mode-btn active' : 'mode-btn';
            document.getElementById('btn-guess').className = mode === 'GUESS' ? 'mode-btn active' : 'mode-btn';
            renderFields(); saveFormState();
        }

        function renderFields() {
            const container = document.getElementById('fields-container'); container.innerHTML = '';
            FIELDS.forEach(field => {
                const id = field.replace(' ', '').toLowerCase();
                let html = currentMode === 'READY' ? 
                    `<div class="ctrl-group"><input type="number" id="${id}" class="val-inp" placeholder="0" oninput="saveFormState()"></div>` :
                    `<div class="ctrl-group"><input type="number" id="${id}" class="val-inp" placeholder="0" oninput="saveFormState()"><button class="btn-pm btn-minus" onclick="toggleSign('${id}', '-')">-</button><button class="btn-pm btn-plus" onclick="toggleSign('${id}', '+')">+</button><input type="hidden" id="${id}-sign" value="-"></div>`;
                container.innerHTML += `<div class="field-row"><span class="label">${field}</span>${html}</div>`;
            });
        }

        function toggleSign(id, sign) {
            const p = document.getElementById(id).parentElement;
            p.querySelector('.btn-minus')?.classList.toggle('active', sign==='-');
            p.querySelector('.btn-plus')?.classList.toggle('active', sign==='+');
            const hidden = document.getElementById(id + '-sign'); if(hidden) hidden.value = sign;
            saveFormState();
        }

        function handleFileSelect(input) {
            if(input.files[0]) { videoFile=input.files[0]; document.getElementById('vid-card').querySelector('.media-default').style.display='none'; document.getElementById('vid-card').querySelector('.media-attached').style.display='flex'; document.getElementById('vid-info').innerText = (videoFile.size/1048576).toFixed(1)+" MB"; }
        }
        async function toggleAudioRecord() {
            if(audioBlob) return;
            if (!mediaRecorder || mediaRecorder.state === "inactive") {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream); let audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => { audioBlob = new Blob(audioChunks, {type:'audio/webm'}); document.getElementById('aud-card').querySelector('.media-default').style.display='none'; document.getElementById('aud-card').querySelector('.media-attached').style.display='flex'; document.getElementById('aud-info').innerText=(audioBlob.size/1048576).toFixed(1)+" MB"; };
                    mediaRecorder.start(); document.getElementById('aud-text').innerText = "Recording...";
                } catch(e) { alert(e.message); }
            } else mediaRecorder.stop();
        }
        function deleteMedia(type, e) {
            e.stopPropagation();
            if(type === 'vid') { videoFile = null; document.getElementById('vid-input').value = ''; document.getElementById('vid-card').querySelector('.media-default').style.display='flex'; document.getElementById('vid-card').querySelector('.media-attached').style.display='none'; }
            else { audioBlob = null; document.getElementById('aud-card').querySelector('.media-default').style.display='flex'; document.getElementById('aud-card').querySelector('.media-attached').style.display='none'; document.getElementById('aud-text').innerText="Tap to Record"; }
        }

        function getData() {
            const bill = document.getElementById('bill-no').value; let date = document.getElementById('del-date').value;
            let printDate = date ? `(${date.split('-')[2]}-${date.split('-')[1]}-${date.split('-')[0]})` : "(__-__)";
            let text = "", json = {}, hasData = false;
            FIELDS.forEach(field => {
                const id = field.replace(' ', '').toLowerCase(); const val = document.getElementById(id).value;
                if(val && val != '0') {
                    hasData = true; const hField = DICT[field] || field;
                    if(currentMode === 'READY') { json[id] = val; text += `<div style="margin-bottom:5px;"><div style="font-size:16px;">${field}: ${val} Ready</div><div class="p-hin">${hField}: ${val} ${DICT['Ready']}</div></div>`; } 
                    else { const sign = document.getElementById(id+'-sign').value; const word = sign === '-' ? 'Ghata do' : 'Badha do'; json[id] = sign + val; text += `<div style="margin-bottom:5px;"><div style="font-size:16px;">${field} ${val} inch ${word}</div><div class="p-hin">${hField} ${val} ${DICT['inch']} ${DICT[word]}</div></div>`; }
                }
            });
            return { rawBill: bill, printBill: bill ? `(${bill})` : "(___)", rawDate: date, printDate, text, json, hasData };
        }

        function initiateJob(type) {
            const d = getData(); if(!d.rawBill || !d.rawDate) return alert("Enter Bill No & Date"); if(!d.hasData) return alert("Enter measurements");
            currentJobType = type; document.getElementById('btn-no-scan').style.display = type === 'EXTERNAL' ? 'block' : 'none';
            document.getElementById('scanner-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, async (txt) => { stopScanner(); await verifyItem(txt.trim()); });
        }

        function stopScanner() { if(html5QrCode) html5QrCode.stop().catch(()=>{}); document.getElementById('scanner-modal').style.display='none'; }
        function cancelVerification() { document.getElementById('confirm-modal').style.display = 'none'; pendingScannedId = null; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function verifyItem(id) {
            document.getElementById('global-loader').style.display = 'block';
            const { data: item, error } = await altClient.from('items').select('*, designs(name, image_url)').eq('id', id).single();
            document.getElementById('global-loader').style.display = 'none';
            if(error || !item) return alert("Not found!");
            pendingScannedId = id; dbExistingBill = item.bill_number; isUrgentItem = !!(item.packet_id);
            document.getElementById('v-img').src = item.designs?.image_url || '';
            document.getElementById('v-name').innerText = item.designs?.name || 'Unknown';
            document.getElementById('v-id').innerText = item.id; document.getElementById('v-size').innerText = item.size;
            document.getElementById('urgent-box').style.display = isUrgentItem ? 'block' : 'none';
            const { data: bill } = await altClient.from('bills').select('customer_name').eq('bill_number', dbExistingBill || document.getElementById('bill-no').value).single();
            document.getElementById('bvb-bill').innerText = "#" + (dbExistingBill || document.getElementById('bill-no').value);
            document.getElementById('bvb-cust').innerText = bill?.customer_name || 'Not Found';
            document.getElementById('bvb-err').style.display = bill ? 'none' : 'block';
            if (dbExistingBill && dbExistingBill != document.getElementById('bill-no').value) {
                document.getElementById('conflict-box').style.display = 'block'; document.getElementById('main-actions-row').style.display = 'none';
                document.getElementById('old-bill-val').innerText = dbExistingBill; document.getElementById('new-bill-val').innerText = document.getElementById('bill-no').value;
            } else { document.getElementById('conflict-box').style.display = 'none'; document.getElementById('main-actions-row').style.display = 'flex'; }
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function resolveConflict(choice) { if(choice==='OLD') document.getElementById('bill-no').value = dbExistingBill; document.getElementById('conflict-box').style.display='none'; document.getElementById('main-actions-row').style.display='flex'; }

        async function processAssignment() {
            document.getElementById('confirm-modal').style.display = 'none'; document.getElementById('global-loader').style.display = 'block';
            let vidUrl = null, audUrl = null;
            if(currentJobType === 'INTERNAL') {
                if(videoFile) { const n=`v_${pendingScannedId}_${Date.now()}.mp4`; await altClient.storage.from('alteration-media').upload(n,videoFile); vidUrl=altClient.storage.from('alteration-media').getPublicUrl(n).data.publicUrl; }
                if(audioBlob) { const n=`a_${pendingScannedId}_${Date.now()}.webm`; await altClient.storage.from('alteration-media').upload(n,audioBlob); audUrl=altClient.storage.from('alteration-media').getPublicUrl(n).data.publicUrl; }
            }
            const d = getData(); const isFront = document.getElementById('front-open').checked;
            let newLoc = currentJobType === 'EXTERNAL' ? 'EXTERNAL_ALTERATION' : (isUrgentItem ? 'URGENT_ALTERATION' : 'MASTER_PENDING');
            await altClient.from('items').update({ bill_number: d.rawBill, current_location: newLoc }).eq('id', pendingScannedId);
            await altClient.from('logs').insert([{ item_id: pendingScannedId, action_type: 'SENT_TO_ALTERATION' }]);
            await altClient.from('alterations').insert([{ item_id: pendingScannedId, type: currentMode, measurements: d.json, text_instruction: d.text, is_front_open: isFront, video_note_url: vidUrl, voice_note_url: audUrl, bill_number_manual: d.rawBill, delivery_date: d.rawDate }]);
            document.getElementById('global-loader').style.display = 'none'; localStorage.removeItem('alt_form_data');
            if(currentJobType === 'EXTERNAL') prepareSlipImage(d); else showSuccess();
        }

        function printWithoutScan() { stopScanner(); prepareSlipImage(getData()); }

        function prepareSlipImage(d) {
            document.getElementById('p-datetime').innerText = new Date().toLocaleString();
            document.getElementById('p-bill').innerText = "Bill: " + d.printBill; document.getElementById('p-date').innerText = "Del: " + d.printDate;
            document.getElementById('p-body').innerHTML = d.text; document.getElementById('p-footer').style.display = document.getElementById('front-open').checked ? 'block' : 'none';
            html2canvas(document.getElementById('print-area')).then(canvas => {
                canvas.toBlob(blob => {
                    const file = new File([blob], "slip.png", { type: "image/png" });
                    if(navigator.share) navigator.share({ files: [file] }).then(showSuccess); else { const a = document.createElement('a'); a.href = canvas.toDataURL(); a.download = 'slip.png'; a.click(); showSuccess(); }
                });
            });
        }

        function showSuccess() { document.getElementById('success-overlay').style.display='flex'; setTimeout(()=>location.reload(), 2000); }

        initApp();
    </script>
</body>
</html>
