<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Royal Sherwani - Alteration Station</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --bg-cream: #F5F5DC;
            --royal-maroon: #800000;
            --gold: #D4AF37;
            --white: #FFFFFF;
            --charcoal: #333333;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-cream); margin: 0; padding: 0; color: var(--charcoal); overflow-x: hidden; }

        header { background: var(--royal-maroon); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; height: 60px; }
        .header-left { font-weight: bold; font-size: 16px; letter-spacing: 1px; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #ff4444; border: 2px solid white; display: inline-block; }
        .status-dot.online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        
        .btn-restart { background: #fff; color: var(--royal-maroon); border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .logout-btn { background: var(--gold); border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; color: var(--royal-maroon); }

        /* Settings Button - Only on Login */
        #settings-btn { 
            position: fixed; bottom: 20px; left: 20px; z-index: 9999; 
            background: white; border: 2px solid var(--royal-maroon); border-radius: 50%; 
            width: 50px; height: 50px; font-size: 26px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }

        .view { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-card { background: white; border-radius: 15px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid var(--royal-maroon); }
        .section-title { font-size: 13px; font-weight: bold; color: var(--royal-maroon); text-transform: uppercase; margin-bottom: 15px; display: block; }
        
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #ccc; border-radius: 10px; font-size: 16px; outline: none; background: #fff; }
        
        /* Disabled Input Style */
        input:disabled { background: #e0e0e0; color: #555; border-color: #bbb; cursor: not-allowed; }

        .measurement-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .m-input-group { background: #fdf5e6; padding: 10px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 5px; }
        .m-label { font-size: 11px; font-weight: 900; color: var(--royal-maroon); display: block; margin-bottom: 5px; text-transform: uppercase; }

        .mode-toggle { display: flex; gap: 15px; margin-bottom: 20px; justify-content: center; }
        .btn-mode { flex: 1; padding: 14px; border: 2px solid var(--royal-maroon); border-radius: 12px; font-weight: 900; font-size: 14px; background: none; cursor: pointer; transition: 0.2s; }
        .btn-mode.active { background: var(--royal-maroon); color: white; }

        .guess-row { display: flex; align-items: center; justify-content: space-between; gap: 5px; }
        .btn-adj { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #bbb; background: #fff; font-weight: bold; font-size: 22px; cursor: pointer; }
        .val-display { font-size: 18px; font-weight: 900; color: var(--royal-maroon); flex: 1; text-align: center; }

        .option-box { display: flex; align-items: center; gap: 10px; background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #eee; cursor: pointer; }
        .option-box input { width: 22px; height: 22px; margin: 0; cursor: pointer; }
        .option-box span { font-size: 14px; font-weight: bold; color: #444; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 15px; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 450px; padding: 25px; max-height: 90vh; overflow-y: auto; text-align: center; }
        
        .btn-main { background: var(--royal-maroon); color: white; border: none; width: 100%; padding: 18px; border-radius: 12px; font-size: 18px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        #selected-pcs-info { background: #e3f2fd; color: #1565c0; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 900; margin-top: 8px; border: 1px solid #bbdefb; display: none; }
        
        canvas { display: none; }
    </style>
</head>
<body>

    <button id="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>

    <header id="app-header" style="display: none;">
        <div class="header-left">ROYAL ALTRATION</div>
        <div style="display:flex; align-items:center; gap:12px;">
            <button class="btn-restart" onclick="resetPage()">RESET üîÑ</button>
            <div id="status-dot" class="status-dot"></div>
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
        </div>
    </header>

    <div id="login-page" style="padding: 40px 20px; text-align: center;">
        <h1 style="color: var(--royal-maroon); margin-top: 50px;">Royal Sherwani</h1>
        <p style="color: grey; font-size: 14px; margin-bottom: 30px;">Alteration Management Station</p>
        <div style="max-width: 400px; margin: auto;">
            <input type="email" id="login-email" placeholder="Staff Email" style="margin-bottom:10px;">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn-main" onclick="handleLogin()">Login to Station</button>
        </div>
    </div>

    <div id="alt-view" class="view">
        <div style="background: #fdf5e6; padding: 15px; border-radius: 12px; border: 1px solid var(--gold); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span id="p-status" style="font-size:13px; font-weight:bold; color:red;">üñ®Ô∏è Printer: Disconnected</span>
            <button onclick="pairPrinter()" style="padding:8px 15px; background:var(--royal-maroon); color:white; border:none; border-radius:8px; font-weight:bold; font-size:12px;">PAIR BT</button>
        </div>

        <div class="section-card">
            <span class="section-title">1. Piece Identification</span>
            
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <input type="number" id="bill-no-field" placeholder="Bill No." oninput="autoSaveDraft()">
                <button id="fetch-bill-btn" class="btn-mode" style="border-width:1px; font-size:12px; flex:0.6;" onclick="fetchBillItems()">FETCH BILL</button>
            </div>

            <div style="display: flex; gap: 8px;">
                <input type="text" id="pcs-id-field" placeholder="Scan PCS ID" oninput="handlePcsSearch()">
                <button class="btn-adj" style="width:55px; height:55px; background:#eee;" onclick="startScanner('pcs-id-field')">üì∑</button>
            </div>
            
            <div id="selected-pcs-info"></div>
        </div>

        <div class="section-card">
            <span class="section-title">2. Alteration Details</span>
            <div class="mode-toggle">
                <button class="btn-mode active" id="mode-fix" onclick="setMode('fix')">FIX SIZE</button>
                <button class="btn-mode" id="mode-guess" onclick="setMode('guess')">GUESS (+/-)</button>
            </div>
            
            <div class="measurement-layout">
                <div id="col-left"></div>
                <div id="col-right"></div>
            </div>

            <div style="margin-top: 20px;">
                <label class="option-box">
                    <input type="checkbox" id="check-front" onchange="autoSaveDraft()">
                    <span>Front Open Pattern</span>
                </label>
                <label class="option-box">
                    <input type="checkbox" id="check-notify" onchange="autoSaveDraft()">
                    <span>WhatsApp Check Required</span>
                </label>
            </div>

            <textarea id="manual-notes" placeholder="Any extra instructions..." style="margin-top:15px; height:100px;" oninput="autoSaveDraft()"></textarea>
        </div>

        <button class="btn-main" onclick="generatePreview()">PREPARE PRINT SLIP ‚ö°</button>
    </div>

    <div id="item-modal" class="modal"><div class="modal-content"><h3>Select Bill Item</h3><div id="bill-items-list"></div><button class="btn-main" style="background:grey;" onclick="closeModal('item-modal')">Close</button></div></div>
    
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--royal-maroon);">PRINT PREVIEW</h3>
            <div id="canvas-container" style="background:#eee; padding:10px; border-radius:10px; margin-bottom:15px;">
                <img id="preview-img" style="width:100%; border:1px solid #ccc;">
            </div>
            <button class="btn-main" onclick="finalizeAndPrint()">CONFIRM & PRINT ‚úÖ</button>
            <button class="btn-main" style="background:grey;" onclick="closeModal('preview-modal')">Cancel / Edit</button>
        </div>
    </div>

    <div id="qr-modal" class="modal"><div class="modal-content"><div id="qr-reader"></div><button class="btn-main" style="background:grey;" onclick="stopScanner()">Stop</button></div></div>
    <div id="settings-modal" class="modal"><div class="modal-content"><h3>Database Configuration</h3><input type="text" id="db-url" placeholder="Supabase URL"><input type="text" id="db-key" placeholder="Anon Key"><button class="btn-main" onclick="saveConfig()">Save & Reload</button></div></div>

    <canvas id="thermal-canvas" width="384"></canvas>

    <script>
        let supabaseClient, html5QrCode, activeMode = 'fix', currentBill = null, selectedItemName = null, printerChar = null;
        let billInventoryMap = {}; // Stores ItemName -> PCS ID mapping

        const leftArr = ['Kamar', 'Hips', 'Thai', 'Ghutna', 'Pindli', 'Mori', 'Pent Length'];
        const rightArr = ['Shoulder', 'Chest', 'Pet', 'Crossback', 'Baju', 'Length', 'Inner Length', 'Byseps'];
        let mValues = {};

        const hindiMap = {
            'Kamar': '‡§ï‡§Æ‡§∞', 'Hips': '‡§π‡§ø‡§™‡•ç‡§∏', 'Thai': '‡§•‡§æ‡§à', 'Ghutna': '‡§ò‡•Å‡§ü‡§®‡§æ',
            'Pindli': '‡§™‡§ø‡§Ç‡§°‡§≤‡•Ä', 'Mori': '‡§Æ‡•ã‡§∞‡•Ä', 'Pent Length': '‡§™‡•á‡§Ç‡§ü ‡§≤‡§Ç‡§¨‡§æ‡§à', 'Length': '‡§≤‡§Ç‡§¨‡§æ‡§à', 
            'Shoulder': '‡§∂‡•ã‡§≤‡•ç‡§°‡§∞', 'Chest': '‡§ö‡•á‡§∏‡•ç‡§ü', 'Pet': '‡§™‡•á‡§ü', 'Crossback': '‡§ï‡•ç‡§∞‡•â‡§∏‡§¨‡•à‡§ï', 
            'Baju': '‡§¨‡§æ‡§ú‡•Ç', 'Inner Length': '‡§á‡§®‡§∞ ‡§≤‡§Ç‡§¨‡§æ‡§à', 'Byseps': '‡§¨‡§æ‡§á‡§∏‡•á‡§™‡•ç‡§∏',
            'Ready kardo': '‡§§‡•à‡§Ø‡§æ‡§∞ ‡§ï‡§∞ ‡§¶‡•ã', 'Badha do': '‡§¨‡•ù‡§æ ‡§¶‡•ã', 'Ghata do': '‡§ò‡§ü‡§æ ‡§¶‡•ã',
            'inch': '‡§á‡§Ç‡§ö'
        };

        window.addEventListener('popstate', function(event) {
            const modals = document.querySelectorAll('.modal');
            let isModalOpen = false;
            modals.forEach(m => { if(m.style.display === 'flex') { m.style.display = 'none'; isModalOpen = true; } });
            if(isModalOpen) return;
            if(document.getElementById('alt-view').classList.contains('active')) { history.pushState({view: 'app'}, ""); }
        });

        async function initApp() {
            const url = localStorage.getItem('rs-url'), key = localStorage.getItem('rs-key');
            if(url && key) { supabaseClient = supabase.createClient(url, key); checkDB(); }
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) enterApp();
        }

        async function checkDB() {
            const { error } = await supabaseClient.from('bills').select('id').limit(1);
            if(!error) document.getElementById('status-dot').classList.add('online');
        }

        async function handlePcsSearch() {
            const pid = document.getElementById('pcs-id-field').value;
            if(pid.length < 8) return;

            const { data } = await supabaseClient.from('inventory').select('*').eq('pcs_id', pid).single();
            const display = document.getElementById('selected-pcs-info');

            if(data && data.bill_number) {
                document.getElementById('bill-no-field').value = data.bill_number;
                await fetchBillDetails(data.bill_number);
                selectedItemName = data.bill_item_name;
                display.innerHTML = `‚úÖ ALREADY LINKED: <b>${data.bill_item_name}</b>`;
                display.style.display = 'block';
                // Lock the field as we found a match via scan
                document.getElementById('pcs-id-field').disabled = true;
            } else {
                display.style.display = 'none';
            }
            autoSaveDraft();
        }

        async function fetchBillItems() {
            const bno = document.getElementById('bill-no-field').value;
            if(!bno) return alert("Enter Bill number!");
            await fetchBillDetails(bno);
        }

        async function fetchBillDetails(bno) {
            // 1. Fetch Bill
            const { data: billData } = await supabaseClient.from('bills').select('*').eq('bill_number', bno).single();
            if(!billData) return alert("Bill not found!");
            currentBill = billData;

            // 2. Fetch Inventory Links for this Bill (To detect pre-linked items)
            const { data: invData } = await supabaseClient.from('inventory').select('pcs_id, bill_item_name').eq('bill_number', bno);
            billInventoryMap = {};
            if(invData) {
                invData.forEach(row => {
                    if(row.bill_item_name) billInventoryMap[row.bill_item_name] = row.pcs_id;
                });
            }

            // 3. Render Items Modal
            const list = document.getElementById('bill-items-list'); list.innerHTML = '';
            (billData.items_json || []).forEach((it) => {
                const linkedId = billInventoryMap[it.name];
                const statusTag = linkedId ? `<span style="font-size:11px; color:green; display:block;">(Linked: ${linkedId})</span>` : `<span style="font-size:11px; color:red; display:block;">(Not Linked)</span>`;
                
                list.innerHTML += `
                <div style="padding:15px; background:${linkedId ? '#e8f5e9' : '#fff3e0'}; margin-bottom:10px; border-radius:12px; font-weight:bold; cursor:pointer; border:1px solid #ddd;" 
                     onclick="assignItem('${it.name}')">
                    ${it.name} ${statusTag}
                </div>`;
            });
            openModal('item-modal');
        }

        function assignItem(name) {
            selectedItemName = name;
            const linkedId = billInventoryMap[name];
            const display = document.getElementById('selected-pcs-info');
            const pcsInput = document.getElementById('pcs-id-field');

            if(linkedId) {
                // Item ALREADY LINKED: Auto-fill and Lock
                pcsInput.value = linkedId;
                pcsInput.disabled = true;
                display.innerHTML = `üîí LINKED: <b>${name}</b> (ID: ${linkedId})`;
                display.style.display = 'block';
                display.style.backgroundColor = '#e8f5e9'; // Greenish bg
                display.style.color = '#2e7d32';
            } else {
                // Item NOT LINKED: Clear and Unlock for Scanning
                pcsInput.value = '';
                pcsInput.disabled = false;
                display.innerHTML = `‚ö†Ô∏è LINKING TO: <b>${name}</b><br><span style="font-size:11px">Scan new ID to link</span>`;
                display.style.display = 'block';
                display.style.backgroundColor = '#fff3e0'; // Orange bg
                display.style.color = '#ef6c00';
            }
            
            closeModal('item-modal'); 
            autoSaveDraft();
        }

        function renderInputs() {
            const draw = (arr, targetId) => {
                const container = document.getElementById(targetId); container.innerHTML = '';
                arr.forEach(key => {
                    const savedVal = mValues[key] || (activeMode === 'fix' ? '' : 0);
                    let html = activeMode === 'fix' ? 
                        `<input type="number" value="${savedVal}" placeholder="0.0" oninput="updateVal('${key}', this.value)">` : 
                        `<div class="guess-row"><button class="btn-adj" onclick="adjustGuess('${key}', -0.5)">-</button><span class="val-display">${savedVal > 0 ? '+' : ''}${savedVal}</span><button class="btn-adj" onclick="adjustGuess('${key}', 0.5)">+</button></div>`;
                    container.innerHTML += `<div class="m-input-group"><span class="m-label">${key}</span>${html}</div>`;
                });
            };
            draw(leftArr, 'col-left'); draw(rightArr, 'col-right');
        }

        function updateVal(k, v) { mValues[k] = v; autoSaveDraft(); }
        function adjustGuess(k, amt) { mValues[k] = parseFloat(((mValues[k] || 0) + amt).toFixed(1)); renderInputs(); autoSaveDraft(); }
        function setMode(m) { activeMode = m; document.getElementById('mode-fix').className = m==='fix'?'btn-mode active':'btn-mode'; document.getElementById('mode-guess').className = m==='guess'?'btn-mode active':'btn-mode'; renderInputs(); }

        function generatePreview() {
            const canvas = document.getElementById('thermal-canvas'), ctx = canvas.getContext('2d');
            const billNo = document.getElementById('bill-no-field').value;
            const isFrontOpen = document.getElementById('check-front').checked;
            const isWhatsApp = document.getElementById('check-notify').checked;
            const note = document.getElementById('manual-notes').value;
            const delDate = currentBill && currentBill.delivery_date ? currentBill.delivery_date : "N/A";
            const now = new Date();
            const dateStr = now.toLocaleDateString();
            const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            const filledKeys = Object.keys(mValues).filter(k => mValues[k] && mValues[k] != 0);
            let extraLines = 0;
            if(isFrontOpen) extraLines += 2; 
            if(isWhatsApp) extraLines += 2;
            if(note) extraLines += Math.ceil(note.length/30);

            canvas.height = 360 + (filledKeys.length * 60) + (extraLines * 60);
            ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "black"; 
            const centerX = canvas.width / 2;
            
            ctx.textAlign = "center";
            ctx.font = "bold 28px Arial"; ctx.fillText("ROYAL SHERWANI", centerX, 50);
            ctx.font = "16px Arial"; ctx.fillText(`${dateStr} | ${timeStr}`, centerX, 75);
            
            ctx.font = "bold 18px Arial"; 
            ctx.textAlign = "left"; ctx.fillText(`BILL: #${billNo}`, 20, 110);
            ctx.textAlign = "right"; ctx.fillText(`DEL: ${delDate}`, 364, 110);
            
            ctx.textAlign = "center";
            if(selectedItemName) ctx.fillText(selectedItemName, centerX, 135);
            ctx.fillRect(20, 145, 344, 3);

            let y = 180;
            filledKeys.forEach(k => {
                const val = mValues[k];
                const hKey = hindiMap[k] || k;
                let line1 = "", line2 = "";
                if(activeMode === 'fix') {
                    line1 = `${k}: ${val} inch Ready kardo`;
                    line2 = `${hKey}: ${val} ${hindiMap['inch']} ${hindiMap['Ready kardo']}`;
                } else {
                    const action = val > 0 ? 'Badha do' : 'Ghata do';
                    line1 = `${k}: ${Math.abs(val)} inch ${action}`;
                    line2 = `${hKey}: ${Math.abs(val)} ${hindiMap['inch']} ${hindiMap[action]}`;
                }
                ctx.font = "bold 22px Arial"; ctx.fillText(line1, centerX, y);
                ctx.font = "bold 20px Arial"; ctx.fillText(line2, centerX, y + 26);
                y += 65;
            });

            if(isFrontOpen) {
                y += 10; ctx.font = "bold 16px Arial"; ctx.fillText("--- IMPORTANT ---", centerX, y); y+=25;
                ctx.font = "bold 18px Arial"; ctx.fillText("Ye Close pattern samne se Open kardo", centerX, y);
                ctx.font = "bold 18px Arial"; ctx.fillText("‡§Ø‡•á ‡§ï‡•ç‡§≤‡•ã‡§ú ‡§™‡•à‡§ü‡§∞‡•ç‡§® ‡§∏‡§æ‡§Æ‡§®‡•á ‡§∏‡•á ‡§ì‡§™‡§® ‡§ï‡§∞ ‡§¶‡•ã", centerX, y+24); y += 65;
            }
            if(isWhatsApp) {
                y += 10; ctx.font = "bold 16px Arial"; ctx.fillText("--- WARNING ---", centerX, y); y+=25;
                ctx.font = "bold 18px Arial"; ctx.fillText("Altration se pehle WhatsApp check Karo", centerX, y);
                ctx.font = "bold 18px Arial"; ctx.fillText("‡§ë‡§≤‡•ç‡§ü‡•ç‡§∞‡•á‡§∂‡§® ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§ö‡•á‡§ï ‡§ï‡§∞‡•ã", centerX, y+24); y += 65;
            }
            if(note) { ctx.font = "14px Arial"; ctx.fillText("Note: " + note, centerX, y + 15); }

            document.getElementById('preview-img').src = canvas.toDataURL();
            openModal('preview-modal');
        }

        async function finalizeAndPrint() {
            const pid = document.getElementById('pcs-id-field').value;
            const bno = document.getElementById('bill-no-field').value;

            if(!pid) return alert("Pcs ID missing!");

            // Always update status to ALTRATION. 
            // If scanning new ID for unlinked item, also update linkage.
            // If ID was already linked (input disabled), this still works correctly.
            await supabaseClient.from('inventory').update({
                status: 'ALTRATION',
                bill_number: parseInt(bno),
                bill_item_name: selectedItemName
            }).eq('pcs_id', pid);

            if(printerChar) {
                const canvas = document.getElementById('thermal-canvas');
                const ctx = canvas.getContext('2d');
                const imgData = ctx.getImageData(0,0,canvas.width, canvas.height);
                let commands = [0x1B, 0x40, 0x1D, 0x76, 0x30, 0, 48, 0, (canvas.height & 0xFF), (canvas.height >> 8) & 0xFF];
                for (let y=0; y<canvas.height; y++) {
                    for (let x=0; x<48; x++) {
                        let byte = 0;
                        for (let bit=0; bit<8; bit++) {
                            const idx = ((y * canvas.width) + (x * 8 + bit)) * 4;
                            if (imgData.data[idx] < 128) byte |= (1 << (7 - bit));
                        }
                        commands.push(byte);
                    }
                }
                commands.push(0x0A, 0x0A, 0x1D, 0x56, 0x01);
                const data = new Uint8Array(commands);
                for (let i = 0; i < data.length; i += 20) await printerChar.writeValue(data.slice(i, i + 20));
            }

            alert("‚úÖ STATUS UPDATED TO ALTRATION!");
            resetPage();
        }

        async function pairPrinter() {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                printerChar = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
                document.getElementById('p-status').innerText = "üñ®Ô∏è Printer: ‚úÖ CONNECTED";
                document.getElementById('p-status').style.color = "green";
            } catch (e) { alert("BT Error: " + e.message); }
        }

        function autoSaveDraft() {
            const d = { 
                b: document.getElementById('bill-no-field').value, p: document.getElementById('pcs-id-field').value,
                m: activeMode, vals: mValues, name: selectedItemName,
                fr: document.getElementById('check-front').checked,
                wa: document.getElementById('check-notify').checked, 
                note: document.getElementById('manual-notes').value
            };
            localStorage.setItem('alt_draft', JSON.stringify(d));
        }

        function loadDraft() {
            const d = JSON.parse(localStorage.getItem('alt_draft'));
            if(!d) { renderInputs(); return; }
            document.getElementById('bill-no-field').value = d.b;
            document.getElementById('pcs-id-field').value = d.p;
            activeMode = d.m; mValues = d.vals || {}; selectedItemName = d.name;
            document.getElementById('check-front').checked = d.fr;
            document.getElementById('check-notify').checked = d.wa;
            document.getElementById('manual-notes').value = d.note;
            renderInputs(); setMode(activeMode);
        }

        function enterApp() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-header').style.display = 'flex';
            document.getElementById('settings-btn').style.display = 'none';
            document.getElementById('alt-view').classList.add('active');
            history.pushState({view: 'app'}, "");
            loadDraft();
        }

        function resetPage() { localStorage.removeItem('alt_draft'); location.reload(); }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; history.pushState({modal: id}, ""); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; history.back(); }
        
        function startScanner(tid) { document.getElementById('qr-modal').style.display='flex'; history.pushState({modal: 'qr'}, ""); html5QrCode = new Html5Qrcode("qr-reader"); html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(t)=>{ document.getElementById(tid).value=t; stopScanner(); handlePcsSearch(); }); }
        function stopScanner() { if(html5QrCode) html5QrCode.stop().then(()=> { document.getElementById('qr-modal').style.display='none'; history.back(); }); }
        
        async function handleLogin() { const e=document.getElementById('login-email').value, p=document.getElementById('login-pass').value; await supabaseClient.auth.signInWithPassword({email:e, password:p}); enterApp(); }
        async function logout() { await supabaseClient.auth.signOut(); location.reload(); }
        function openSettings() { if(prompt("Code:")==='5563990') document.getElementById('settings-modal').style.display='flex'; }
        function saveConfig() { localStorage.setItem('rs-url', document.getElementById('db-url').value); localStorage.setItem('rs-key', document.getElementById('db-key').value); location.reload(); }
        window.onload = initApp;
    </script>
</body>
</html>

